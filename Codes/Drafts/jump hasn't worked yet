#include <SFML/Graphics.hpp>
#include <SFML/Audio.hpp>

using namespace sf;

// Constants
const int WIDTH = 1000;
const int HEIGHT = 1000;
const float  moveSpeed = 2.0f;
const float jump_strength = -8.0f;
const float gravity = 0.08f;
bool isGround = false;
bool once = true;

// Textures
Texture tex_background, tex_ground, tex_wall_right, tex_wall_left, tex_player;

// Sprites
Sprite background , ground , wall, wall2;

// Player Struct
struct Players {
    Sprite sprite;
    float velocity_x;
    float velocity_y;
    int frameIndex;

    // Constructor to load the player sprite
    Players() {
        velocity_x = 0;
        velocity_y = 0;
        frameIndex = 0;

        // Load the player texture
        if (!tex_player.loadFromFile("player.png")) {
            throw std::runtime_error("Failed to load player texture");
        }

        sprite.setTexture(tex_player);
        sprite.setTextureRect(IntRect(0, 0, 42, 71)); // Crop sprite
        sprite.setPosition(300, 642);
        sprite.setScale(2.4f, 2.4f);
    }

    void handleMovement() {
        if (Keyboard::isKeyPressed(Keyboard::Right)) {
            sprite.setScale(2.4, 2.4);
            velocity_x = moveSpeed;
            sprite.setTextureRect(IntRect(frameIndex * 37, 0, 42, 71));
            frameIndex++;
            frameIndex = frameIndex  % 4;
        }
        else if (Keyboard::isKeyPressed(Keyboard::Left)) {
            sprite.setScale(-2.4, 2.4);
            velocity_x = -moveSpeed;
            sprite.setTextureRect(IntRect(frameIndex * 37, 0, 42, 71));
            frameIndex++;
            frameIndex = frameIndex % 4;
        }
        else {
            velocity_x = 0; // Stop when no key is pressed
        }

       sprite.move(velocity_x, 0);
    }

    void jump() {
        if (Keyboard::isKeyPressed(Keyboard::Space) && once) {

            //if (sprite.getPosition().y < HEIGHT / 2) {
            //    //cameraControl = true;
            //}

            sprite.setScale(2.4, 2.4);
            frameIndex = 5;
            sprite.setTextureRect(IntRect(frameIndex * 37, 0, 42, 71));

            if (isGround) {

                velocity_y = jump_strength;  // Apply jump strength
                isGround = false;       // Player is no longer grounded

                //sound.play();
            }

            // Apply gravity and move player vertically
            if (!isGround) {
                velocity_y += gravity;  // Gravity pulls the player downwards
                frameIndex = 0;
                sprite.setTextureRect(IntRect(frameIndex * 37, 0, 42, 71));
            }
            once = false;/*ensures the jump canâ€™t be triggered again until the key is released
                     (preventing the player from jumping multiple times without touching the ground).*/

        }

    }

};

void initializeObject(RenderWindow& window) {
    // Load textures
    if (!tex_background.loadFromFile("background.jpg")) return;
    if (!tex_ground.loadFromFile("ground.jpg")) return;
    if (!tex_wall_right.loadFromFile("wall.jpg")) return;
    if (!tex_wall_left.loadFromFile("wall2.jpg")) return;
    if (!tex_player.loadFromFile("player.png")) return;


    background.setTexture(tex_background);
    background.setScale(static_cast<float>(window.getSize().x) / tex_background.getSize().x,
        static_cast<float>(window.getSize().y) / tex_background.getSize().y);
    background.setPosition(0, 0);

    ground.setTexture(tex_ground);
    ground.setPosition(-50, 800);
    ground.setScale(1.5, 1.5);

    wall.setTexture(tex_wall_right);
    wall.setPosition(0, 0);
    wall.setScale(1.5, 3);

    wall2.setTexture(tex_wall_left);
    wall2.setPosition(880, 0);
    wall2.setScale(1.5, 3);



}

void draw(RenderWindow& window, Players& player) {
    window.draw(background);
    window.draw(ground);
    window.draw(wall);
    window.draw(wall2);
    window.draw(player.sprite);
}

int main() {
    RenderWindow window(VideoMode(WIDTH, HEIGHT), "Icy Tower SFML");

    initializeObject(window);
    Players player;

    // Initialization
    int i = 0;
    player.velocity_y = 0;



    while (window.isOpen()) {
        sf::Event event;
        while (window.pollEvent(event)) {
            if (event.type == sf::Event::Closed) {
                window.close();
            }
        }

        //Collision detection with the ground
        if (player.sprite.getGlobalBounds().intersects(ground.getGlobalBounds())) {
            player.sprite.setPosition(player.sprite.getPosition().x, 812 - player.sprite.getGlobalBounds().height);  // Position on the ground
            isGround = true;
            player.velocity_y = 0;
        }

        //Collision detection with the wall
        if (player.sprite.getGlobalBounds().intersects(wall.getGlobalBounds())) {
            player.sprite.setPosition(50+player.sprite.getPosition().x,812);  // Position on the wall
            player.velocity_x = 0;
        }

        //Collision detection with the wall
        else if (player.sprite.getGlobalBounds().intersects(wall2.getGlobalBounds())) {
            player.sprite.setPosition(1500-player.sprite.getPosition().x, 812);  // Position on the wall
            player.velocity_x = 0;
        }

        player.handleMovement();

        window.clear();
        draw(window, player);
        window.display();
    }
}
